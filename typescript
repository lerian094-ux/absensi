import React, { useState, useEffect, useRef } from "react";

/**
 * Check-in Absensi Kelas (Single-file React component)
 * - Tailwind CSS utility classes used for styling (assumes Tailwind is configured)
 * - Persists data to localStorage so teacher doesn't lose records on refresh
 * - Features:
 *   - Teacher view: buat kelas, lihat daftar hadir, export CSV, atur jam mulai
 *   - Student check-in: masukkan nama + kode kelas untuk absen (cek-in otomatis mencatat waktu)
 *   - Catatan: Ini adalah solusi frontend-only (no server). Untuk penyimpanan terpusat, hubungkan API backend.
 *
 * Cara pakai cepat:
 * 1. Import dan render <AttendanceApp /> di aplikasi React Anda.
 * 2. Pastikan Tailwind sudah aktif supaya tampilan rapi. Jika belum, gaya masih bekerja tanpa Tailwind tapi lebih sederhana.
 * 3. Teacher dapat membuat "Class Code" lalu bagikan ke siswa. Siswa memasukkan nama + kode untuk check-in.
 */

export default function AttendanceApp() {
  const [classes, setClasses] = useState(() => {
    try {
      return JSON.parse(localStorage.getItem("attendance_classes_v1")) || [];
    } catch (e) {
      return [];
    }
  });

  const [selectedClassId, setSelectedClassId] = useState(null);
  const [studentName, setStudentName] = useState("");
  const [studentCode, setStudentCode] = useState("");
  const [teacherMode, setTeacherMode] = useState(true);
  const nameInputRef = useRef(null);

  useEffect(() => {
    localStorage.setItem("attendance_classes_v1", JSON.stringify(classes));
  }, [classes]);

  useEffect(() => {
    if (!selectedClassId && classes.length) setSelectedClassId(classes[0].id);
  }, [classes, selectedClassId]);

  function generateCode() {
    // simple human-friendly code
    return Math.random().toString(36).slice(2, 8).toUpperCase();
  }

  function createClass(title = "Kelas Baru") {
    const id = Date.now().toString();
    const code = generateCode();
    const newClass = {
      id,
      title,
      code,
      createdAt: new Date().toISOString(),
      records: [] // { id, name, time }
    };
    setClasses((s) => [newClass, ...s]);
    setSelectedClassId(id);
  }

  function removeClass(id) {
    if (!confirm("Hapus kelas ini beserta semua rekaman?")) return;
    setClasses((s) => s.filter((c) => c.id !== id));
    if (selectedClassId === id) setSelectedClassId(null);
  }

  function renameClass(id, newTitle) {
    setClasses((s) => s.map((c) => (c.id === id ? { ...c, title: newTitle } : c)));
  }

  function studentCheckIn(e) {
    e.preventDefault();
    const name = studentName.trim();
    const code = studentCode.trim().toUpperCase();
    if (!name || !code) return alert("Isi nama dan kode kelas.");

    const target = classes.find((c) => c.code === code);
    if (!target) return alert("Kode kelas tidak ditemukan.");

    // prevent duplicate check-in within same session by exact name match
    const already = target.records.some((r) => r.name.toLowerCase() === name.toLowerCase());
    if (already) return alert("Nama sudah terdaftar (sudah check-in).");

    const record = { id: Date.now().toString(), name, time: new Date().toISOString() };
    setClasses((s) => s.map((c) => (c.code === code ? { ...c, records: [...c.records, record] } : c)));
    setStudentName("");
    setStudentCode("");
    if (nameInputRef.current) nameInputRef.current.focus();
  }

  function teacherAddRecord(classId) {
    const name = prompt("Nama siswa yang ditambahkan:");
    if (!name) return;
    const record = { id: Date.now().toString(), name: name.trim(), time: new Date().toISOString() };
    setClasses((s) => s.map((c) => (c.id === classId ? { ...c, records: [...c.records, record] } : c)));
  }

  function exportCSV(classId) {
    const cls = classes.find((c) => c.id === classId);
    if (!cls) return;
    const rows = ["No,Name,Time (ISO)"].concat(
      cls.records.map((r, i) => `${i + 1},"${r.name.replace(/"/g, '""')}",${r.time}`)
    );
    const blob = new Blob([rows.join("\n")], { type: "text/csv;charset=utf-8;" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = `${cls.title.replace(/\s+/g, "_")}_attendance.csv`;
    a.click();
    URL.revokeObjectURL(url);
  }

  function clearRecords(classId) {
    if (!confirm("Kosongkan semua rekaman hadir untuk kelas ini?")) return;
    setClasses((s) => s.map((c) => (c.id === classId ? { ...c, records: [] } : c)));
  }

  const selectedClass = classes.find((c) => c.id === selectedClassId) || null;

  return (
    <div className="min-h-screen p-6 bg-slate-50 text-slate-900">
      <div className="max-w-5xl mx-auto">
        <header className="flex items-center justify-between mb-6">
          <h1 className="text-2xl font-semibold">Absensi Check‑In Kelas</h1>
          <div className="flex items-center gap-3">
            <button
              onClick={() => setTeacherMode((s) => !s)}
              className="px-3 py-1 rounded-md border"
            >
              {teacherMode ? "Mode Guru" : "Mode Siswa"}
            </button>
            <button
              onClick={() => createClass("Kelas Baru")}
              className="px-3 py-1 rounded-md bg-emerald-500 text-white"
            >
              + Buat Kelas
            </button>
          </div>
        </header>

        <main className="grid grid-cols-1 md:grid-cols-3 gap-6">
          {/* Left column: student check-in */}
          <section className="md:col-span-1 bg-white p-4 rounded-lg shadow-sm">
            <h2 className="font-medium mb-3">Check-in Siswa</h2>
            <form onSubmit={studentCheckIn}>
              <label className="block text-sm">Nama</label>
              <input
                ref={nameInputRef}
                value={studentName}
                onChange={(e) => setStudentName(e.target.value)}
                className="w-full mt-1 mb-3 p-2 rounded-md border"
                placeholder="Masukkan nama lengkap"
              />

              <label className="block text-sm">Kode Kelas</label>
              <input
                value={studentCode}
                onChange={(e) => setStudentCode(e.target.value)}
                className="w-full mt-1 mb-3 p-2 rounded-md border uppercase"
                placeholder="Contoh: ABC123"
              />

              <div className="flex gap-2">
                <button type="submit" className="px-3 py-2 rounded-md bg-blue-600 text-white">
                  Check-in
                </button>
                <button
                  type="button"
                  onClick={() => {
                    setStudentName("");
                    setStudentCode("");
                  }}
                  className="px-3 py-2 rounded-md border"
                >
                  Reset
                </button>
              </div>

              <p className="mt-3 text-xs text-slate-500">Masukkan kode kelas yang diberikan guru untuk melakukan check-in otomatis (waktu tercatat otomatis).</p>
            </form>
          </section>

          {/* Middle column: classes list */}
          <section className="md:col-span-1 bg-white p-4 rounded-lg shadow-sm">
            <h2 className="font-medium mb-3">Daftar Kelas</h2>
            {classes.length === 0 && (
              <div className="text-sm text-slate-500">Belum ada kelas. Klik "+ Buat Kelas" untuk memulai.</div>
            )}
            <ul className="space-y-3">
              {classes.map((c) => (
                <li key={c.id} className={`p-3 rounded-md border ${selectedClassId === c.id ? "ring-2 ring-indigo-200" : ""}`}>
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="font-semibold">{c.title}</div>
                      <div className="text-xs text-slate-500">Kode: <span className="font-mono">{c.code}</span></div>
                    </div>
                    <div className="flex gap-2">
                      <button onClick={() => { navigator.clipboard?.writeText(c.code); alert('Kode disalin: ' + c.code); }} className="px-2 py-1 text-sm border rounded">Salin</button>
                      <button onClick={() => setSelectedClassId(c.id)} className="px-2 py-1 text-sm border rounded">Buka</button>
                    </div>
                  </div>
                  <div className="mt-2 flex gap-2">
                    <button
                      onClick={() => {
                        const newTitle = prompt("Nama baru kelas:", c.title);
                        if (newTitle) renameClass(c.id, newTitle.trim());
                      }}
                      className="text-xs px-2 py-1 border rounded"
                    >
                      Ubah Nama
                    </button>
                    <button onClick={() => teacherAddRecord(c.id)} className="text-xs px-2 py-1 border rounded">Tambah Absen</button>
                    <button onClick={() => exportCSV(c.id)} className="text-xs px-2 py-1 border rounded">Export CSV</button>
                    <button onClick={() => clearRecords(c.id)} className="text-xs px-2 py-1 border rounded">Kosongkan</button>
                    <button onClick={() => removeClass(c.id)} className="text-xs px-2 py-1 border rounded text-red-600">Hapus</button>
                  </div>
                </li>
              ))}
            </ul>
          </section>

          {/* Right column: selected class details */}
          <section className="md:col-span-1 bg-white p-4 rounded-lg shadow-sm">
            <h2 className="font-medium mb-3">Detail Kelas</h2>
            {!selectedClass && <div className="text-sm text-slate-500">Pilih kelas untuk melihat daftar hadir.</div>}

            {selectedClass && (
              <div>
                <div className="mb-3">
                  <div className="text-sm font-semibold">{selectedClass.title}</div>
                  <div className="text-xs text-slate-500">Kode: <span className="font-mono">{selectedClass.code}</span></div>
                  <div className="text-xs text-slate-400">Dibuat: {new Date(selectedClass.createdAt).toLocaleString()}</div>
                </div>

                <div className="mb-2 flex items-center justify-between">
                  <div className="text-sm font-medium">Daftar Hadir ({selectedClass.records.length})</div>
                  <div className="text-xs text-slate-500">(terurut by waktu masuk)</div>
                </div>

                <div className="space-y-2 max-h-64 overflow-auto">
                  {selectedClass.records.length === 0 && <div className="text-sm text-slate-500">Belum ada yang check-in.</div>}
                  {selectedClass.records.map((r, idx) => (
                    <div key={r.id} className="flex items-center justify-between p-2 border rounded">
                      <div>
                        <div className="font-medium">{idx + 1}. {r.name}</div>
                        <div className="text-xs text-slate-500">{new Date(r.time).toLocaleString()}</div>
                      </div>
                      <div className="flex gap-2">
                        <button onClick={() => {
                          // remove single record
                          if (!confirm('Hapus absen untuk ' + r.name + '?')) return;
                          setClasses((s) => s.map((c) => c.id === selectedClass.id ? { ...c, records: c.records.filter(rr => rr.id !== r.id) } : c));
                        }} className="px-2 py-1 text-xs border rounded text-red-600">Hapus</button>
                      </div>
                    </div>
                  ))}
                </div>

                <div className="mt-4 flex gap-2">
                  <button onClick={() => exportCSV(selectedClass.id)} className="px-3 py-2 rounded-md border">Export CSV</button>
                  <button onClick={() => clearRecords(selectedClass.id)} className="px-3 py-2 rounded-md border">Kosongkan</button>
                </div>
              </div>
            )}

          </section>
        </main>

        <footer className="mt-6 text-xs text-slate-500">Simple attendance app — frontend-only. Untuk integrasi (Google Sheets, server, autentikasi), beri tahu saya supaya saya tambahkan backend.</footer>
      </div>
    </div>
  );
}
